<!-- Reading UI: Shared styles and scripts for chapter/scripture templates -->

<!-- Reader Settings Popup -->
<div id="reader-settings" class="reader-settings" style="display:none;">
    <div class="rs-header">READER SETTINGS</div>
    
    <div class="rs-section">
        <div class="rs-toggle-group" id="font-size-group">
            <button class="rs-toggle" data-size="font-small" onclick="setFontSize('font-small')">
                <span class="rs-aa rs-aa-sm">A</span><span class="rs-aa rs-aa-sm">A</span>
            </button>
            <button class="rs-toggle active" data-size="font-medium" onclick="setFontSize('font-medium')">
                <span class="rs-aa">A</span><span class="rs-aa">A</span>
            </button>
            <button class="rs-toggle" data-size="font-large" onclick="setFontSize('font-large')">
                <span class="rs-aa rs-aa-lg">A</span><span class="rs-aa rs-aa-lg">A</span>
            </button>
        </div>
    </div>

    <div class="rs-section">
        <div class="rs-toggle-group" id="font-family-group">
            <button class="rs-toggle active" data-font="font-serif" onclick="setFontFamily('font-serif')">
                <span class="rs-font-label" style="font-family: 'Source Serif Pro', Georgia, serif;">Serif</span>
            </button>
            <button class="rs-toggle" data-font="font-sans" onclick="setFontFamily('font-sans')">
                <span class="rs-font-label" style="font-family: 'Source Sans Pro', system-ui, sans-serif;">Sans</span>
            </button>
        </div>
    </div>
</div>
<div id="reader-settings-backdrop" class="rs-backdrop" style="display:none;" onclick="toggleReaderSettings()"></div>

<style>
/* ============================================
   SCROLL LOCK (no shift)
   ============================================ */
html {
    scrollbar-gutter: stable;
}
body.overlay-open {
    overflow: hidden;
}

/* ============================================
   READING TOOLBAR (Bible.com style)
   ============================================ */
.reading-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    margin-bottom: 2rem;
    position: sticky;
    top: 0;
    background: var(--color-bg, #fff);
    z-index: 100;
    /* Widen beyond 600px content to 900px */
    margin-left: -150px;
    margin-right: -150px;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 0.35rem;
}

/* Outlined select style */
.toolbar-select {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    cursor: pointer;
    padding: 0.45rem 0.75rem;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    transition: all 0.15s ease;
}

.toolbar-select:hover {
    border-color: var(--color-accent, #9c7c38);
    background: var(--color-bg-alt, #f9f9f9);
}

.toolbar-select-value {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-primary, #000);
    line-height: 1;
}

.toolbar-select svg {
    color: var(--color-text-secondary, #555);
}

.toolbar-translation-static {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.8rem;
    color: var(--color-text-muted, #888);
    text-transform: uppercase;
    letter-spacing: 0.06em;
}

/* Bordered button style (AA, PDF) */
.toolbar-btn {
    background: none;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    padding: 0.5rem 0.85rem;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    color: var(--color-primary, #000);
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.toolbar-btn:hover {
    border-color: var(--color-accent, #9c7c38);
    background: var(--color-bg-alt, #f9f9f9);
}

.toolbar-divider {
    width: 1px;
    height: 20px;
    background: var(--color-border, #e5e5e5);
    margin: 0 0.25rem;
}

/* Font size button */
.font-btn {
    gap: 0.1rem;
    padding: 0.45rem 0.7rem;
}

.font-icon {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.75rem;
    line-height: 1;
}

.font-icon-lg {
    font-size: 1.1rem;
}

/* ============================================
   READER SETTINGS POPUP
   ============================================ */
.rs-backdrop {
    position: fixed;
    inset: 0;
    z-index: 149;
}

.reader-settings {
    position: fixed;
    top: 60px;
    right: 60px;
    width: 280px;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    z-index: 150;
    overflow: hidden;
}

.rs-header {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-text-muted, #888);
    text-align: center;
    padding: 1rem 1rem 0.75rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
}

.rs-section {
    padding: 0.85rem 1rem;
}

.rs-section + .rs-section {
    border-top: 1px solid var(--color-border, #e5e5e5);
}

.rs-toggle-group {
    display: flex;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 10px;
    overflow: hidden;
}

.rs-toggle {
    flex: 1;
    padding: 0.65rem 0.5rem;
    background: var(--color-bg, #fff);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.05rem;
    transition: all 0.12s ease;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
}

.rs-toggle + .rs-toggle {
    border-left: 1px solid var(--color-border, #e5e5e5);
}

.rs-toggle:hover {
    background: var(--color-bg-alt, #f5f5f5);
}

.rs-toggle.active {
    background: var(--color-primary, #000);
    color: #fff;
}

/* Font size labels */
.rs-aa {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 1rem;
    font-weight: 600;
    line-height: 1;
}

.rs-aa-sm {
    font-size: 0.75rem;
}

.rs-aa-lg {
    font-size: 1.25rem;
}

/* Font family labels */
.rs-font-label {
    font-size: 0.9rem;
    font-weight: 600;
}

/* ============================================
   SHARED OVERLAY STYLES
   ============================================ */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.overlay-content {
    background: var(--color-bg, #fff);
    border-radius: 16px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.overlay-narrow {
    max-width: 420px;
    width: 90%;
}

.overlay-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    flex-shrink: 0;
}

.overlay-header h3 {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-primary, #000);
}

.overlay-close {
    background: none;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary, #555);
    transition: all 0.15s ease;
}

.overlay-close:hover {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

/* ============================================
   BOOKS LIST
   ============================================ */
.overlay .books-list {
    overflow-y: auto;
    padding: 0.5rem;
    flex: 1;
}

.book-item {
    display: block;
    width: 100%;
    text-align: left;
    padding: 0.55rem 0.85rem;
    background: none;
    border: none;
    border-radius: 6px;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    color: var(--color-text, #1a1a1a);
    cursor: pointer;
    transition: all 0.1s ease;
    text-decoration: none;
}

.book-item:hover {
    background: var(--color-bg-alt, #f5f5f5);
}

.book-item.active {
    background: var(--color-primary, #000);
    color: #fff;
    font-weight: 600;
}

/* ============================================
   CHAPTER GRID
   ============================================ */
.overlay .chapter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 6px;
    padding: 0.75rem 1.25rem 1.25rem;
    overflow-y: auto;
    flex: 1;
}

.chapter-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-primary, #000);
    text-decoration: none;
    transition: all 0.12s ease;
}

.chapter-cell:hover {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

.chapter-cell.active {
    background: var(--color-accent, #9c7c38);
    color: #fff;
    border-color: var(--color-accent, #9c7c38);
}

/* ============================================
   FLOATING PREV/NEXT ARROWS (PILL)
   ============================================ */
.float-arrow {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 72px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    color: var(--color-text-muted, #aaa);
    text-decoration: none;
    transition: all 0.2s ease;
    z-index: 50;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.float-prev { left: max(12px, calc(50% - 420px)); }
.float-next { right: max(12px, calc(50% - 420px)); }

.float-arrow:hover {
    background: var(--color-primary, #000);
    border-color: var(--color-primary, #000);
    color: #fff;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

/* ============================================
   VERSE TAP TOOLTIP
   ============================================ */
.chapter-content .verse {
    cursor: pointer;
    border-radius: 3px;
    transition: background-color 0.15s;
}

.chapter-content .verse:hover {
    background-color: rgba(156, 124, 56, 0.06);
}

.chapter-content .verse.verse-selected {
    background-color: rgba(156, 124, 56, 0.12);
}

.verse-tooltip {
    position: fixed;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--color-primary, #000);
    border-radius: 10px;
    padding: 0.4rem 0.55rem;
    box-shadow: 0 6px 24px rgba(0,0,0,0.3);
    z-index: 300;
    white-space: nowrap;
    animation: vtFadeIn 0.12s ease;
}

@keyframes vtFadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.verse-tooltip::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid var(--color-primary, #000);
}

/* Arrow flips when tooltip is below the click */
.verse-tooltip.tooltip-below::after {
    bottom: auto;
    top: -6px;
    border-top: none;
    border-bottom: 6px solid var(--color-primary, #000);
}

.verse-tooltip-ref {
    color: rgba(255,255,255,0.6);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.72rem;
    padding: 0 0.3rem;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.verse-tooltip-divider {
    width: 1px;
    height: 16px;
    background: rgba(255,255,255,0.2);
    flex-shrink: 0;
}

.verse-tooltip-btn {
    background: none;
    border: none;
    color: #fff;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.76rem;
    font-weight: 600;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: background 0.12s;
    white-space: nowrap;
}

.verse-tooltip-btn:hover {
    background: rgba(255,255,255,0.15);
}

/* ============================================
   BIBLE SEARCH BAR (toolbar)
   ============================================ */
.toolbar-search-wrapper {
    position: relative;
    flex: 1;
    max-width: 280px;
    margin: 0 0.5rem;
}

.toolbar-search {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    padding: 0.35rem 0.6rem;
    transition: border-color 0.15s;
}

.toolbar-search:focus-within {
    border-color: var(--color-accent, #9c7c38);
}

.toolbar-search-icon {
    flex-shrink: 0;
    color: var(--color-text-muted, #aaa);
}

.toolbar-search-input {
    border: none;
    outline: none;
    background: transparent;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.82rem;
    color: var(--color-text, #1a1a1a);
    width: 100%;
}

.toolbar-search-input::placeholder {
    color: var(--color-text-muted, #aaa);
}

/* Search dropdown */
.bible-search-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    z-index: 300;
    max-height: 70vh;
    overflow-y: auto;
}

.bsd-item {
    display: block;
    padding: 0.6rem 0.75rem;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--color-border-light, #f0f0f0);
    transition: background 0.1s;
}

.bsd-item:last-child { border-bottom: none; }

.bsd-item:hover {
    background: var(--color-bg-alt, #f9f9f9);
}

.bsd-title {
    display: block;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-primary, #000);
}

.bsd-sub {
    display: block;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.72rem;
    color: var(--color-text-muted, #888);
    margin-top: 0.1rem;
    line-height: 1.4;
}

.bsd-nav .bsd-title::before {
    content: 'â†’ ';
    color: var(--color-accent, #9c7c38);
}

.bsd-empty {
    padding: 0.75rem;
    text-align: center;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.8rem;
    color: var(--color-text-muted, #888);
    font-style: italic;
}

/* ============================================
   CHAPTER BODY
   ============================================ */
.chapter-reading {
    max-width: 720px;
    margin: 0 auto;
    padding: 0 60px;
}

/* Widen in parallel mode */
.chapter-reading.parallel-active {
    max-width: 1200px;
    padding: 0 24px;
}
.chapter-reading.parallel-active .reading-toolbar {
    margin-left: 0;
    margin-right: 0;
}
/* In parallel mode, tuck arrows to screen edges */
.chapter-reading.parallel-active .float-prev { left: 12px; }
.chapter-reading.parallel-active .float-next { right: 12px; }

/* ============================================
   PARALLEL SPLIT LAYOUT
   ============================================ */
.chapter-split {
    padding: 0 0 2rem;
}

.chapter-split.parallel-mode {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

.chapter-pane-right {
    border-left: 1px solid var(--color-border, #e5e5e5);
    padding-left: 2rem;
}

.pane-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
}

.pane-label {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted, #888);
}

.pane-close {
    background: none;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted, #888);
    transition: all 0.15s;
}

.pane-close:hover {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

.parallel-loading {
    color: var(--color-text-muted, #888);
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
}

/* Active state for parallel toggle button */
.parallel-btn.active {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

/* ============================================
   TOOLBAR TOOLTIPS (CSS, instant)
   ============================================ */
.toolbar-right .toolbar-btn,
.toolbar-right .pdf-btn-minimal {
    position: relative;
}
.toolbar-right .toolbar-btn::after,
.toolbar-right .pdf-btn-minimal::after {
    content: attr(data-tip);
    position: absolute;
    bottom: -32px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-primary, #000);
    color: #fff;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 200;
}
.toolbar-right .toolbar-btn:hover::after,
.toolbar-right .pdf-btn-minimal:hover::after {
    opacity: 1;
}

.chapter-footer {
    border-top: 1px solid var(--color-border, #e5e5e5);
    padding: 1.5rem 0 3rem;
    text-align: center;
}

.translation-note {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    color: var(--color-text-muted, #888);
    margin: 0;
}

/* ============================================
   FONT SIZE + FONT FAMILY
   Applied to #chapter-text and #parallel-pane
   ============================================ */
#chapter-text.font-small, #parallel-pane.font-small,
#chapter-text.font-small h2, #parallel-pane.font-small h2,
#chapter-text.font-small h3, #parallel-pane.font-small h3 { font-size: 0.95rem; }

#chapter-text.font-medium, #parallel-pane.font-medium { font-size: 1.1rem; }
#chapter-text.font-medium h2, #parallel-pane.font-medium h2 { font-size: 1.35rem; }
#chapter-text.font-medium h3, #parallel-pane.font-medium h3 { font-size: 1.15rem; }

#chapter-text.font-large, #parallel-pane.font-large { font-size: 1.3rem; }
#chapter-text.font-large h2, #parallel-pane.font-large h2 { font-size: 1.6rem; }
#chapter-text.font-large h3, #parallel-pane.font-large h3 { font-size: 1.35rem; }

#chapter-text.font-serif, #parallel-pane.font-serif,
#chapter-text.font-serif h2, #parallel-pane.font-serif h2,
#chapter-text.font-serif h3, #parallel-pane.font-serif h3 {
    font-family: 'Source Serif Pro', Georgia, serif;
}
#chapter-text.font-sans, #parallel-pane.font-sans,
#chapter-text.font-sans h2, #parallel-pane.font-sans h2,
#chapter-text.font-sans h3, #parallel-pane.font-sans h3 {
    font-family: 'Source Sans Pro', system-ui, sans-serif;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 900px) {
    .reading-toolbar {
        margin-left: 0;
        margin-right: 0;
    }
    .float-arrow {
        width: 32px;
        height: 64px;
    }
    .float-prev { left: 8px; }
    .float-next { right: 8px; }
    .chapter-reading { padding: 0 48px; }
}

@media (max-width: 900px) {
    /* Stack parallel panes vertically on medium screens */
    .chapter-split.parallel-mode {
        grid-template-columns: 1fr;
    }
    .chapter-pane-right {
        border-left: none;
        padding-left: 0;
        border-top: 1px solid var(--color-border, #e5e5e5);
        padding-top: 1.5rem;
    }
    .chapter-reading.parallel-active {
        max-width: 720px;
        padding: 0 48px;
    }
}

@media (max-width: 640px) {
    .chapter-reading { padding: 0 12px; }
    .chapter-reading.parallel-active { padding: 0 12px; }

    .reading-toolbar {
        gap: 0.5rem;
    }

    .toolbar-select-value {
        font-size: 0.82rem;
    }

    .toolbar-left {
        gap: 0.4rem;
    }

    .toolbar-divider {
        display: none;
    }

    /* Search: show icon only, tap to expand */
    .toolbar-search-wrapper {
        max-width: none;
        margin: 0;
        position: static;
    }

    .toolbar-search {
        width: 34px;
        height: 34px;
        padding: 0;
        justify-content: center;
        cursor: pointer;
    }

    .toolbar-search-input {
        display: none;
        width: 0;
    }

    /* Expanded state: full-width bar at top */
    .toolbar-search-wrapper.search-expanded .toolbar-search {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 50px;
        border-radius: 0;
        border: none;
        border-bottom: 2px solid var(--color-accent, #9c7c38);
        background: var(--color-bg, #fff);
        padding: 0 0.75rem;
        z-index: 400;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .toolbar-search-wrapper.search-expanded .toolbar-search-input {
        display: block;
        width: 100%;
        font-size: 1rem;
    }

    .toolbar-search-wrapper.search-expanded .bible-search-dropdown {
        position: fixed;
        top: 50px;
        left: 0;
        right: 0;
        border-radius: 0;
        max-height: calc(80vh - 50px);
        z-index: 400;
    }

    .mobile-search-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.3);
        z-index: 350;
    }

    .float-arrow {
        width: 32px;
        height: 56px;
        top: auto;
        bottom: 24px;
        transform: none;
    }
    .float-prev { left: 8px; }
    .float-next { right: 8px; }

    .reader-settings {
        right: 12px;
        left: 12px;
        width: auto;
    }
}

/* ============================================
   SCRIPTURE REFERENCE POPUPS
   ============================================ */
.scripture-ref {
    color: inherit;
    text-decoration: none;
    border-bottom: 1px dotted var(--color-accent, #9c7c38);
    cursor: pointer;
    transition: border-color 0.15s ease, color 0.15s ease;
}

.scripture-ref:hover {
    border-bottom-color: var(--color-primary, #000);
    color: var(--color-accent, #9c7c38);
}

.scripture-popup {
    position: absolute;
    z-index: 2000;
    width: 360px;
    max-width: calc(100vw - 32px);
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 12px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    animation: spFadeIn 0.15s ease;
}

@keyframes spFadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
}

.sp-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    background: var(--color-bg-alt, #f9f9f9);
}

.sp-label {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-primary, #000);
}

.sp-close {
    background: none;
    border: none;
    font-size: 0.85rem;
    color: var(--color-text-muted, #888);
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    transition: all 0.15s;
    line-height: 1;
}

.sp-close:hover {
    background: var(--color-primary, #000);
    color: #fff;
}

.sp-body {
    padding: 0.85rem 1rem;
    max-height: 240px;
    overflow-y: auto;
    font-family: var(--font-body, 'Source Serif Pro', Georgia, serif);
    font-size: 0.92rem;
    line-height: 1.7;
    color: var(--color-text, #1a1a1a);
}

.sp-body sup {
    color: var(--color-accent, #9c7c38);
    font-weight: bold;
    font-size: 0.75em;
}

.sp-verses em { font-style: italic; }
.sp-verses strong { font-weight: bold; }
.sp-verses u { text-decoration: underline; }

.sp-loading {
    color: var(--color-text-muted, #888);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    text-align: center;
    padding: 0.5rem 0;
}

.sp-error {
    color: var(--color-text-muted, #888);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    text-align: center;
    padding: 0.5rem 0;
    font-style: italic;
}

.sp-link {
    display: block;
    padding: 0.6rem 1rem;
    border-top: 1px solid var(--color-border, #e5e5e5);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.8rem;
    color: var(--color-accent, #9c7c38);
    text-decoration: none;
    text-align: center;
    transition: background 0.15s;
}

.sp-link:hover {
    background: var(--color-bg-alt, #f9f9f9);
}

@media (max-width: 640px) {
    .scripture-popup {
        width: calc(100vw - 24px);
        left: 12px !important;
    }
}
</style>

<script>
/* ---- Overlay helpers ---- */
function openOverlay(id) {
    document.getElementById(id).style.display = 'flex';
    document.body.classList.add('overlay-open');
}
function closeOverlay(id) {
    document.getElementById(id).style.display = 'none';
    document.body.classList.remove('overlay-open');
}
function toggleOverlay(id) {
    var el = document.getElementById(id);
    if (el.style.display === 'none') openOverlay(id);
    else closeOverlay(id);
}

// Close overlay on backdrop click
['book-overlay', 'chapter-overlay', 'trans-overlay'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('click', function(e) {
        if (e.target === this) closeOverlay(id);
    });
});

/* ---- Book Overlay ---- */
function toggleBookOverlay() {
    toggleOverlay('book-overlay');
    // Scroll active book into view
    var active = document.querySelector('#book-overlay .book-item.active');
    if (active) active.scrollIntoView({ block: 'center', behavior: 'instant' });
}

/* ---- Chapter Overlay ---- */
function toggleChapterOverlay() {
    toggleOverlay('chapter-overlay');
}

/* ---- Translation Overlay ---- */
function toggleTransOverlay() {
    var el = document.getElementById('trans-overlay');
    if (el) toggleOverlay('trans-overlay');
}

/* ---- Reader Settings ---- */
function toggleReaderSettings() {
    var rs = document.getElementById('reader-settings');
    var bd = document.getElementById('reader-settings-backdrop');
    if (rs.style.display === 'none') {
        rs.style.display = 'block';
        bd.style.display = 'block';
    } else {
        rs.style.display = 'none';
        bd.style.display = 'none';
    }
}

/* ---- Font Size ---- */
var currentFontSize = 'font-medium';

function syncParallelPane() {
    var pp = document.getElementById('parallel-pane');
    if (!pp) return;
    pp.classList.remove('font-small', 'font-medium', 'font-large', 'font-serif', 'font-sans');
    pp.classList.add(currentFontSize, currentFontFamily);
}

function setFontSize(size) {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    el.classList.remove('font-small', 'font-medium', 'font-large');
    el.classList.add(size);
    currentFontSize = size;
    syncParallelPane();
    document.querySelectorAll('#font-size-group .rs-toggle').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-size') === size);
    });
    try { sessionStorage.setItem('cir-font-size', size); } catch(e) {}
}

/* ---- Font Family ---- */
var currentFontFamily = 'font-serif';

function setFontFamily(font) {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    el.classList.remove('font-serif', 'font-sans');
    el.classList.add(font);
    currentFontFamily = font;
    syncParallelPane();
    document.querySelectorAll('#font-family-group .rs-toggle').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-font') === font);
    });
    try { sessionStorage.setItem('cir-font-family', font); } catch(e) {}
}

/* ---- Restore settings on load ---- */
(function() {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    try {
        var savedSize = sessionStorage.getItem('cir-font-size') || 'font-medium';
        var savedFont = sessionStorage.getItem('cir-font-family') || 'font-serif';
        el.classList.add(savedSize, savedFont);
        currentFontSize = savedSize;
        currentFontFamily = savedFont;
        // Sync buttons
        document.querySelectorAll('#font-size-group .rs-toggle').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-size') === savedSize);
        });
        document.querySelectorAll('#font-family-group .rs-toggle').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-font') === savedFont);
        });
    } catch(e) {
        el.classList.add('font-medium', 'font-serif');
    }
})();

/* ---- Verse Tap Tooltip ---- */
(function() {
    var tooltip = null;
    var selectedVerse = null;

    function removeTooltip() {
        if (tooltip) { tooltip.remove(); tooltip = null; }
        if (selectedVerse) { selectedVerse.classList.remove('verse-selected'); selectedVerse = null; }
    }

    function getVerseNums(el) {
        var nums = [];
        el.querySelectorAll('sup').forEach(function(sup) {
            var t = sup.textContent.trim().replace(/[^0-9\-]/g, '');
            if (!t) return;
            var parts = t.split('-').filter(Boolean);
            if (parts.length === 2) {
                var a = parseInt(parts[0], 10), b = parseInt(parts[1], 10);
                if (!isNaN(a) && !isNaN(b)) { for (var n = a; n <= b; n++) nums.push(n); }
            } else {
                var v = parseInt(parts[0], 10);
                if (!isNaN(v)) nums.push(v);
            }
        });
        return nums;
    }

    function getRef(el) {
        var vals = document.querySelectorAll('.toolbar-select-value');
        var book = vals[0] ? vals[0].textContent.trim() : '';
        var chap = vals[1] ? vals[1].textContent.trim() : '';
        var nums = getVerseNums(el);
        if (nums.length === 0) return book + ' ' + chap;
        nums.sort(function(a,b) { return a - b; });
        nums = nums.filter(function(v,i) { return i === 0 || v !== nums[i-1]; });
        var ranges = [], s = nums[0], e = nums[0];
        for (var i = 1; i < nums.length; i++) {
            if (nums[i] === e + 1) { e = nums[i]; }
            else { ranges.push(s === e ? '' + s : s + '-' + e); s = e = nums[i]; }
        }
        ranges.push(s === e ? '' + s : s + '-' + e);
        return book + ' ' + chap + ':' + ranges.join(', ');
    }

    function getText(el) {
        var clone = el.cloneNode(true);
        clone.querySelectorAll('.verse-num').forEach(function(s) { s.remove(); });
        return clone.textContent.trim().replace(/\s+/g, ' ');
    }

    var copyIcon = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none"><rect x="5" y="5" width="9" height="9" rx="1" stroke="#fff" stroke-width="1.3"/><path d="M3 11V2h9" stroke="#fff" stroke-width="1.3" stroke-linecap="round"/></svg>';
    var shareIcon = '<svg width="12" height="12" viewBox="0 0 16 16" fill="none"><circle cx="12" cy="3" r="2" stroke="#fff" stroke-width="1.3"/><circle cx="4" cy="8" r="2" stroke="#fff" stroke-width="1.3"/><circle cx="12" cy="13" r="2" stroke="#fff" stroke-width="1.3"/><path d="M6 9l4 3M6 7l4-3" stroke="#fff" stroke-width="1.3"/></svg>';

    function showTooltip(verseEl, e) {
        removeTooltip();
        selectedVerse = verseEl;
        verseEl.classList.add('verse-selected');

        var ref = getRef(verseEl);
        var text = getText(verseEl);

        tooltip = document.createElement('div');
        tooltip.className = 'verse-tooltip';
        tooltip.innerHTML =
            '<span class="verse-tooltip-ref">' + ref + '</span>' +
            '<span class="verse-tooltip-divider"></span>' +
            '<button class="verse-tooltip-btn" data-action="copy">' + copyIcon + ' Copy</button>' +
            '<span class="verse-tooltip-divider"></span>' +
            '<button class="verse-tooltip-btn" data-action="share">' + shareIcon + ' Share</button>';

        document.body.appendChild(tooltip);

        // Position using fixed coords (viewport-relative, never off-screen)
        var tw = tooltip.offsetWidth;
        var th = tooltip.offsetHeight;
        var cx = e.clientX;
        var cy = e.clientY;

        // Horizontal: center on click, clamp to viewport
        var left = cx - tw / 2;
        if (left < 8) left = 8;
        if (left + tw > window.innerWidth - 8) left = window.innerWidth - tw - 8;

        // Vertical: above click by default, below if not enough room
        var top = cy - th - 12;
        var below = false;
        if (top < 8) {
            top = cy + 16;
            below = true;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        if (below) tooltip.classList.add('tooltip-below');

        // Handle button clicks
        tooltip.addEventListener('click', function(ev) {
            var btn = ev.target.closest('[data-action]');
            if (!btn) return;
            ev.stopPropagation();

            if (btn.dataset.action === 'copy') {
                var copyStr = '\u201c' + text + '\u201d \u2014 ' + ref;
                navigator.clipboard.writeText(copyStr).then(function() {
                    btn.innerHTML = '\u2713 Copied';
                    setTimeout(removeTooltip, 1200);
                }).catch(function() {
                    prompt('Copy this text:', copyStr);
                });
            }

            if (btn.dataset.action === 'share') {
                var shareData = {
                    title: ref,
                    text: '\u201c' + text + '\u201d \u2014 ' + ref,
                    url: window.location.href.split('#')[0] + '#' + (verseEl.id || '')
                };
                if (navigator.share) {
                    navigator.share(shareData).catch(function() {});
                } else {
                    navigator.clipboard.writeText(shareData.url).then(function() {
                        btn.innerHTML = '\u2713 Link copied';
                        setTimeout(removeTooltip, 1200);
                    });
                }
            }
        });
    }

    // Click on verse = show tooltip, click elsewhere = dismiss
    // Skip scripture reference clicks and popup interactions
    document.addEventListener('click', function(e) {
        if (e.target.closest('.scripture-ref') || e.target.closest('.scripture-popup')) {
            return;
        }
        var verse = e.target.closest('.verse');
        if (verse && e.target.closest('.chapter-content')) {
            showTooltip(verse, e);
            return;
        }
        if (!e.target.closest('.verse-tooltip')) {
            removeTooltip();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') removeTooltip();
    });
})();

/* ---- Keyboard Navigation ---- */
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

    if (e.key === 'Escape') {
        closeOverlay('book-overlay');
        closeOverlay('chapter-overlay');
        closeOverlay('trans-overlay');
        var rs = document.getElementById('reader-settings');
        if (rs.style.display !== 'none') toggleReaderSettings();
        return;
    }

    if (e.key === 'ArrowLeft' && typeof prevUrl !== 'undefined' && prevUrl) {
        window.location.href = prevUrl;
    }
    if (e.key === 'ArrowRight' && typeof nextUrl !== 'undefined' && nextUrl) {
        window.location.href = nextUrl;
    }
});
</script>

<!-- Scripture reference popups -->
<script src="{{ "js/scripture-popups.js" | relURL }}"></script>
