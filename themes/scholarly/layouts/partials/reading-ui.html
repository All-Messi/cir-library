<!-- Reading UI: Shared styles and scripts for chapter/scripture templates -->

<!-- Reader Settings Popup -->
<div id="reader-settings" class="reader-settings" style="display:none;">
    <div class="rs-header">READER SETTINGS</div>
    
    <div class="rs-section">
        <div class="rs-toggle-group" id="font-size-group">
            <button class="rs-toggle" data-size="font-small" onclick="setFontSize('font-small')">
                <span class="rs-aa rs-aa-sm">A</span><span class="rs-aa rs-aa-sm">A</span>
            </button>
            <button class="rs-toggle active" data-size="font-medium" onclick="setFontSize('font-medium')">
                <span class="rs-aa">A</span><span class="rs-aa">A</span>
            </button>
            <button class="rs-toggle" data-size="font-large" onclick="setFontSize('font-large')">
                <span class="rs-aa rs-aa-lg">A</span><span class="rs-aa rs-aa-lg">A</span>
            </button>
        </div>
    </div>

    <div class="rs-section">
        <div class="rs-toggle-group" id="font-family-group">
            <button class="rs-toggle active" data-font="font-serif" onclick="setFontFamily('font-serif')">
                <span class="rs-font-label" style="font-family: 'Source Serif Pro', Georgia, serif;">Serif</span>
            </button>
            <button class="rs-toggle" data-font="font-sans" onclick="setFontFamily('font-sans')">
                <span class="rs-font-label" style="font-family: 'Source Sans Pro', system-ui, sans-serif;">Sans</span>
            </button>
        </div>
    </div>
</div>
<div id="reader-settings-backdrop" class="rs-backdrop" style="display:none;" onclick="toggleReaderSettings()"></div>

<style>
/* ============================================
   SCROLL LOCK (no shift)
   ============================================ */
html {
    scrollbar-gutter: stable;
}
body.overlay-open {
    overflow: hidden;
}

/* ============================================
   READING TOOLBAR
   ============================================ */
.reading-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    margin-bottom: 2rem;
    position: sticky;
    top: 0;
    background: var(--color-bg, #fff);
    z-index: 100;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toolbar-btn {
    background: none;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    padding: 0.5rem 0.85rem;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    color: var(--color-primary, #000);
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.toolbar-btn:hover {
    border-color: var(--color-accent, #9c7c38);
    background: var(--color-bg-alt, #f9f9f9);
}

.toolbar-divider {
    width: 1px;
    height: 20px;
    background: var(--color-border, #e5e5e5);
}

.toolbar-translation {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.8rem;
    color: var(--color-text-muted, #888);
    text-transform: uppercase;
    letter-spacing: 0.06em;
}

/* Font size button */
.font-btn {
    gap: 0.1rem;
    padding: 0.45rem 0.7rem;
}

.font-icon {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.75rem;
    line-height: 1;
}

.font-icon-lg {
    font-size: 1.1rem;
}

/* ============================================
   READER SETTINGS POPUP
   ============================================ */
.rs-backdrop {
    position: fixed;
    inset: 0;
    z-index: 149;
}

.reader-settings {
    position: fixed;
    top: 60px;
    right: 60px;
    width: 280px;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    z-index: 150;
    overflow: hidden;
}

.rs-header {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-text-muted, #888);
    text-align: center;
    padding: 1rem 1rem 0.75rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
}

.rs-section {
    padding: 0.85rem 1rem;
}

.rs-section + .rs-section {
    border-top: 1px solid var(--color-border, #e5e5e5);
}

.rs-toggle-group {
    display: flex;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 10px;
    overflow: hidden;
}

.rs-toggle {
    flex: 1;
    padding: 0.65rem 0.5rem;
    background: var(--color-bg, #fff);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.05rem;
    transition: all 0.12s ease;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
}

.rs-toggle + .rs-toggle {
    border-left: 1px solid var(--color-border, #e5e5e5);
}

.rs-toggle:hover {
    background: var(--color-bg-alt, #f5f5f5);
}

.rs-toggle.active {
    background: var(--color-primary, #000);
    color: #fff;
}

/* Font size labels */
.rs-aa {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 1rem;
    font-weight: 600;
    line-height: 1;
}

.rs-aa-sm {
    font-size: 0.75rem;
}

.rs-aa-lg {
    font-size: 1.25rem;
}

/* Font family labels */
.rs-font-label {
    font-size: 0.9rem;
    font-weight: 600;
}

/* ============================================
   SHARED OVERLAY STYLES
   ============================================ */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.overlay-content {
    background: var(--color-bg, #fff);
    border-radius: 16px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.overlay-narrow {
    max-width: 420px;
    width: 90%;
}

.overlay-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    flex-shrink: 0;
}

.overlay-header h3 {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--color-primary, #000);
}

.overlay-close {
    background: none;
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary, #555);
    transition: all 0.15s ease;
}

.overlay-close:hover {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

/* ============================================
   BOOKS LIST
   ============================================ */
.overlay .books-list {
    overflow-y: auto;
    padding: 0.5rem;
    flex: 1;
}

.book-item {
    display: block;
    width: 100%;
    text-align: left;
    padding: 0.55rem 0.85rem;
    background: none;
    border: none;
    border-radius: 6px;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    color: var(--color-text, #1a1a1a);
    cursor: pointer;
    transition: all 0.1s ease;
    text-decoration: none;
}

.book-item:hover {
    background: var(--color-bg-alt, #f5f5f5);
}

.book-item.active {
    background: var(--color-primary, #000);
    color: #fff;
    font-weight: 600;
}

/* ============================================
   CHAPTER GRID
   ============================================ */
.overlay .chapter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 6px;
    padding: 0.75rem 1.25rem 1.25rem;
    overflow-y: auto;
    flex: 1;
}

.chapter-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    aspect-ratio: 1;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-primary, #000);
    text-decoration: none;
    transition: all 0.12s ease;
}

.chapter-cell:hover {
    background: var(--color-primary, #000);
    color: #fff;
    border-color: var(--color-primary, #000);
}

.chapter-cell.active {
    background: var(--color-accent, #9c7c38);
    color: #fff;
    border-color: var(--color-accent, #9c7c38);
}

/* ============================================
   FLOATING PREV/NEXT ARROWS (PILL)
   ============================================ */
.float-arrow {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 72px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    color: var(--color-text-muted, #aaa);
    text-decoration: none;
    transition: all 0.2s ease;
    z-index: 50;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.float-prev { left: 12px; }
.float-next { right: 12px; }

.float-arrow:hover {
    background: var(--color-primary, #000);
    border-color: var(--color-primary, #000);
    color: #fff;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

/* ============================================
   CHAPTER BODY
   ============================================ */
.chapter-reading {
    max-width: 720px;
    margin: 0 auto;
    padding: 0 60px;
}

.chapter-body {
    padding: 0 0 2rem;
}

.chapter-footer {
    border-top: 1px solid var(--color-border, #e5e5e5);
    padding: 1.5rem 0 3rem;
    text-align: center;
}

.translation-note {
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    color: var(--color-text-muted, #888);
    margin: 0;
}

/* ============================================
   FONT SIZE + FONT FAMILY
   Applied to #chapter-text (.chapter-body)
   ============================================ */
#chapter-text.font-small,
#chapter-text.font-small h2,
#chapter-text.font-small h3 { font-size: 0.95rem; }

#chapter-text.font-medium { font-size: 1.1rem; }
#chapter-text.font-medium h2 { font-size: 1.35rem; }
#chapter-text.font-medium h3 { font-size: 1.15rem; }

#chapter-text.font-large { font-size: 1.3rem; }
#chapter-text.font-large h2 { font-size: 1.6rem; }
#chapter-text.font-large h3 { font-size: 1.35rem; }

#chapter-text.font-serif,
#chapter-text.font-serif h2,
#chapter-text.font-serif h3 {
    font-family: 'Source Serif Pro', Georgia, serif;
}
#chapter-text.font-sans,
#chapter-text.font-sans h2,
#chapter-text.font-sans h3 {
    font-family: 'Source Sans Pro', system-ui, sans-serif;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 900px) {
    .float-arrow {
        width: 32px;
        height: 64px;
    }
    .float-prev { left: 6px; }
    .float-next { right: 6px; }
    .chapter-reading { padding: 0 48px; }
}

@media (max-width: 640px) {
    .chapter-reading { padding: 0 12px; }

    .float-arrow {
        width: 32px;
        height: 56px;
        top: auto;
        bottom: 24px;
        transform: none;
    }
    .float-prev { left: 8px; }
    .float-next { right: 8px; }

    .toolbar-translation {
        display: none;
    }

    .reader-settings {
        right: 12px;
        left: 12px;
        width: auto;
    }
}

/* ============================================
   SCRIPTURE REFERENCE POPUPS
   ============================================ */
.scripture-ref {
    color: inherit;
    text-decoration: none;
    border-bottom: 1px dotted var(--color-accent, #9c7c38);
    cursor: pointer;
    transition: border-color 0.15s ease, color 0.15s ease;
}

.scripture-ref:hover {
    border-bottom-color: var(--color-primary, #000);
    color: var(--color-accent, #9c7c38);
}

.scripture-popup {
    position: absolute;
    z-index: 2000;
    width: 360px;
    max-width: calc(100vw - 32px);
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 12px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    animation: spFadeIn 0.15s ease;
}

@keyframes spFadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
}

.sp-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--color-border, #e5e5e5);
    background: var(--color-bg-alt, #f9f9f9);
}

.sp-label {
    font-family: var(--font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-primary, #000);
}

.sp-close {
    background: none;
    border: none;
    font-size: 0.85rem;
    color: var(--color-text-muted, #888);
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    transition: all 0.15s;
    line-height: 1;
}

.sp-close:hover {
    background: var(--color-primary, #000);
    color: #fff;
}

.sp-body {
    padding: 0.85rem 1rem;
    max-height: 240px;
    overflow-y: auto;
    font-family: var(--font-body, 'Source Serif Pro', Georgia, serif);
    font-size: 0.92rem;
    line-height: 1.7;
    color: var(--color-text, #1a1a1a);
}

.sp-body sup {
    color: var(--color-accent, #9c7c38);
    font-weight: bold;
    font-size: 0.75em;
}

.sp-verses em { font-style: italic; }
.sp-verses strong { font-weight: bold; }
.sp-verses u { text-decoration: underline; }

.sp-loading {
    color: var(--color-text-muted, #888);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    text-align: center;
    padding: 0.5rem 0;
}

.sp-error {
    color: var(--color-text-muted, #888);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.85rem;
    text-align: center;
    padding: 0.5rem 0;
    font-style: italic;
}

.sp-link {
    display: block;
    padding: 0.6rem 1rem;
    border-top: 1px solid var(--color-border, #e5e5e5);
    font-family: var(--font-ui, 'Source Sans Pro', sans-serif);
    font-size: 0.8rem;
    color: var(--color-accent, #9c7c38);
    text-decoration: none;
    text-align: center;
    transition: background 0.15s;
}

.sp-link:hover {
    background: var(--color-bg-alt, #f9f9f9);
}

@media (max-width: 640px) {
    .scripture-popup {
        width: calc(100vw - 24px);
        left: 12px !important;
    }
}
</style>

<script>
/* ---- Overlay helpers ---- */
function openOverlay(id) {
    document.getElementById(id).style.display = 'flex';
    document.body.classList.add('overlay-open');
}
function closeOverlay(id) {
    document.getElementById(id).style.display = 'none';
    document.body.classList.remove('overlay-open');
}
function toggleOverlay(id) {
    var el = document.getElementById(id);
    if (el.style.display === 'none') openOverlay(id);
    else closeOverlay(id);
}

// Close overlay on backdrop click
['book-overlay', 'chapter-overlay'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('click', function(e) {
        if (e.target === this) closeOverlay(id);
    });
});

/* ---- Book Overlay ---- */
function toggleBookOverlay() {
    toggleOverlay('book-overlay');
    // Scroll active book into view
    var active = document.querySelector('#book-overlay .book-item.active');
    if (active) active.scrollIntoView({ block: 'center', behavior: 'instant' });
}

/* ---- Chapter Overlay ---- */
function toggleChapterOverlay() {
    toggleOverlay('chapter-overlay');
}

/* ---- Reader Settings ---- */
function toggleReaderSettings() {
    var rs = document.getElementById('reader-settings');
    var bd = document.getElementById('reader-settings-backdrop');
    if (rs.style.display === 'none') {
        rs.style.display = 'block';
        bd.style.display = 'block';
    } else {
        rs.style.display = 'none';
        bd.style.display = 'none';
    }
}

/* ---- Font Size ---- */
var currentFontSize = 'font-medium';

function setFontSize(size) {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    el.classList.remove('font-small', 'font-medium', 'font-large');
    el.classList.add(size);
    currentFontSize = size;
    // Update active button
    document.querySelectorAll('#font-size-group .rs-toggle').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-size') === size);
    });
    try { sessionStorage.setItem('cir-font-size', size); } catch(e) {}
}

/* ---- Font Family ---- */
var currentFontFamily = 'font-serif';

function setFontFamily(font) {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    el.classList.remove('font-serif', 'font-sans');
    el.classList.add(font);
    currentFontFamily = font;
    // Update active button
    document.querySelectorAll('#font-family-group .rs-toggle').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-font') === font);
    });
    try { sessionStorage.setItem('cir-font-family', font); } catch(e) {}
}

/* ---- Restore settings on load ---- */
(function() {
    var el = document.getElementById('chapter-text');
    if (!el) return;
    try {
        var savedSize = sessionStorage.getItem('cir-font-size') || 'font-medium';
        var savedFont = sessionStorage.getItem('cir-font-family') || 'font-serif';
        el.classList.add(savedSize, savedFont);
        currentFontSize = savedSize;
        currentFontFamily = savedFont;
        // Sync buttons
        document.querySelectorAll('#font-size-group .rs-toggle').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-size') === savedSize);
        });
        document.querySelectorAll('#font-family-group .rs-toggle').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-font') === savedFont);
        });
    } catch(e) {
        el.classList.add('font-medium', 'font-serif');
    }
})();

/* ---- Keyboard Navigation ---- */
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

    if (e.key === 'Escape') {
        closeOverlay('book-overlay');
        closeOverlay('chapter-overlay');
        var rs = document.getElementById('reader-settings');
        if (rs.style.display !== 'none') toggleReaderSettings();
        return;
    }

    if (e.key === 'ArrowLeft' && typeof prevUrl !== 'undefined' && prevUrl) {
        window.location.href = prevUrl;
    }
    if (e.key === 'ArrowRight' && typeof nextUrl !== 'undefined' && nextUrl) {
        window.location.href = nextUrl;
    }
});
</script>

<!-- Scripture reference popups -->
<script src="{{ "js/scripture-popups.js" | relURL }}"></script>
