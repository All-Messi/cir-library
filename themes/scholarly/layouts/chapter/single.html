{{ define "main" }}
{{ $allChapters := .Parent.Pages.ByWeight }}
{{ $currentChapter := .Params.chapter }}
{{ $translation := .Parent.Parent }}

<article class="chapter-reading" id="chapter-reading">
    <!-- Top Toolbar -->
    <nav class="reading-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-btn" onclick="toggleBookOverlay()">
                {{ .Params.book }}
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>

            <button class="toolbar-btn" onclick="toggleChapterOverlay()">
                Chapter {{ .Params.chapter }}
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>

            <span class="toolbar-divider"></span>

            <span class="toolbar-translation">{{ $translation.Title }}</span>
        </div>
        <div class="toolbar-right">
            {{ partial "pdf-link.html" (dict "page" . "style" "toolbar") }}
            <button class="toolbar-btn font-btn" onclick="toggleReaderSettings()" title="Reader settings">
                <span class="font-icon">A</span><span class="font-icon font-icon-lg">A</span>
            </button>
        </div>
    </nav>

    <!-- Book Overlay -->
    <div id="book-overlay" class="overlay" style="display:none;">
        <div class="overlay-content overlay-narrow">
            <div class="overlay-header">
                <h3>{{ $translation.Title }}</h3>
                <button class="overlay-close" onclick="toggleBookOverlay()">✕</button>
            </div>
            <div class="books-list">
                {{ $currentBook := .Params.book }}
                {{ range $translation.Sections.ByWeight }}
                <a href="{{ .RelPermalink }}" class="book-item {{ if eq (.Params.book | default .Title) $currentBook }}active{{ end }}">
                    {{ .Params.book | default .Title }}
                </a>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Chapter Overlay -->
    <div id="chapter-overlay" class="overlay" style="display:none;">
        <div class="overlay-content overlay-narrow">
            <div class="overlay-header">
                <h3>{{ .Params.book }}</h3>
                <button class="overlay-close" onclick="toggleChapterOverlay()">✕</button>
            </div>
            <div class="chapter-grid">
                {{ range $allChapters }}
                <a href="{{ .RelPermalink }}" class="chapter-cell {{ if eq .Params.chapter $currentChapter }}active{{ end }}">{{ .Params.chapter }}</a>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Floating Prev/Next Arrows -->
    {{ if .Params.prev }}
    <a href="../{{ .Params.prev }}/" class="float-arrow float-prev" aria-label="Previous chapter">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M12 4l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </a>
    {{ end }}
    {{ if .Params.next }}
    <a href="../{{ .Params.next }}/" class="float-arrow float-next" aria-label="Next chapter">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M8 4l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </a>
    {{ end }}

    <!-- Chapter Content -->
    <div class="chapter-body" id="chapter-text">
        <div class="chapter-content">
            {{ .Content }}
        </div>
    </div>

    <footer class="chapter-footer">
        <p class="translation-note">
            From the {{ .Params.translation }} translation by {{ .Site.Params.author }}
        </p>
    </footer>
</article>

<!-- Keyboard nav data -->
<script>
var prevUrl = {{ if .Params.prev }}"../{{ .Params.prev }}/"{{ else }}null{{ end }};
var nextUrl = {{ if .Params.next }}"../{{ .Params.next }}/"{{ else }}null{{ end }};
</script>

{{ partial "reading-ui.html" . }}
{{ end }}
